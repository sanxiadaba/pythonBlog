{%  extends "baseArticle.html" %}
{%  block writeConfig %}
<script type="text/javascript" src="/static/ue/ueditor.config.js"></script>
<script type="text/javascript" src="/static/ue/ueditor.all.min.js"></script>
<script type="text/javascript" src="/static/ue/lang/zh-cn/zh-cn.js"></script>

<script type="text/javascript">
    var ue = UE.getEditor('content', {
        initialFrameHeight: 400,
        autoHeightEnabled: true,
        serverUrl: "/uedit",
        toolbars: [
            [
                'source', //源代码

                'undo', //撤销
                'redo', //重做
                'removeformat', //清除格式
                'cleardoc', //清空文档


                'bold', //加粗
                'indent', //首行缩进
                'italic', //斜体
                'underline', //下划线
                'strikethrough', //删除线
                'subscript', //下标
                // 'fontborder', //字符边框
                'superscript', //上标
                'formatmatch', //格式刷
                'pasteplain', //纯文本粘贴模式
                'selectall', //全选
                // 'print', //打印
                'horizontal', //分隔线
                'date', //日期

                'time', //时间
                'link', //超链接

                'unlink', //取消链接
                'inserttitle', //插入标题
                'customstyle', //自定义标题

                'insertcode', //代码语言
                'fontfamily', //字体
                'fontsize', //字号
                'paragraph', //段落格式]
            ],
            [
                'simpleupload', //单图上传
                'insertimage', //多图上传
                'inserttable', //插入表格

                'edittable', //表格属性
                'emotion', //表情
                'spechars', //特殊字符
                'searchreplace', //查询替换
                'justifyleft', //居左对齐
                'justifyright', //居右对齐
                'justifycenter', //居中对齐
                'justifyjustify', //两端对齐
                'forecolor', //字体颜色
                'backcolor', //背景色
                'insertorderedlist', //有序列表
                'insertunorderedlist', //无序列表
                'fullscreen', //全屏
                'lineheight', //行间距
                'edittip ', //编辑提示
                'touppercase', //字母大写
                'tolowercase', //字母小写
                'background', //背景
                'preview', //预览

                'help', //帮助

            ]
        ]
    });
</script>
{% endblock %}

{%  block write %}
<label for="headline" class="col-1">文章标题</label>
<input type="text" class="col-11" id="headline">
</div>

<div class="row">
    <script id="content" type="text/plain" style="padding-top: 10px"></script>
</div>


<div class="row form-group" style="margin-top: 20px; padding-top: 10px;">
    <label for="type" class="col-1">类型： </label>
    <select class="form-control col-2" id="type">
        {# {{article_type[article.type |string]}}#}
        {% for k,v in article_type.items()  %}
        <option value="{{ k }}">{{ v }}&nbsp;&nbsp;</option>
        {% endfor %}
    </select>
    <label class="col-1"></label>
    <label for="credit" class="col-1">积分：</label>
    <select class="form-control col-2" id="credit">
        <option value="0">免费</option>
        <option value="1">1分</option>
        <option value="2">2分</option>
        <option value="5">5分</option>
        <option value="10">10分</option>
        <option value="20">20分</option>
        <option value="50">50分</option>
    </select>
    <label class="col-1"></label>
    <button class="form-control btn-default col-2" onclick="doDraft()">保存草稿</button>
{% if session.get("role")=="editor" %}
    <button class="form-control btn-primary col-2" onclick="doPost()">发布文章</button>
{% else %}
<button class="form-control btn-primary col-2" onclick="doPost()">投稿</button>
{% endif %}
    </select>
</div>
<div>


    <script>
        var ARTICLEID = 0;

        function doPost() {
            var headline = $.trim($("#headline").val());
            var contentPlain = UE.getEditor("content").getContentTxt();

            if (headline.length < 5) {
                bootbox.alert({title: "错误提示", message: "标题不能少于五个字"});
                return false;
            } else if (contentPlain.length < 100) {
                bootbox.alert({title: "错误提示", message: "内容不能低于100字"});
                return false;
            }

            var param = "headline=" + headline;
            param += "&content=" + encodeURIComponent(UE.getEditor("content").getContent());
            param += "&type=" + $("#type").val();
            param += "&credit=" + $("#credit").val();
            param += "&drafted=0&checked=1&articleid=" + ARTICLEID;
            $.post("/article", param, function (data) {
                if (data == "perm-denied") {
                    bootbox.alert({title: "错误提示", message: "权限不足，不能发布文章"});
                } else if (data == "post=fail") {
                    bootbox.alert({title: "错误提示", message: "文章发布失败，请联系管理员"});
                } else if (data.match(/^\d+$/)) {
                    bootbox.alert({title: "信息提示", message: "恭喜你发布成功"});
                    setTimeout(function () {
                        location.href = "/article/" + data;
                    }, 1000)
                } else {
                    bootbox.alert({title: "信息提示", message: "文章发布失败，可能没有权限"});

                }

            })
        }

        //    保存草稿代码
        function doDraft() {
            var headline = $.trim($("#headline").val());
            var contentPlain = UE.getEditor("content").getContentTxt();

            if (headline.length < 5) {
                bootbox.alert({title: "错误提示", message: "草稿标题不能少于五个字"});
                return false;
            } else if (contentPlain.length < 10) {
                bootbox.alert({title: "错误提示", message: "草稿内容不能少于10个字"});
                return false;
            }
            var param = "headline=" + headline;
            param += "&content=" + encodeURIComponent(UE.getEditor("content").getContent());
            param += "&type=" + $("#type").val();
            param += "&credit=" + $("#credit").val();
            param += "&drafted=1&checked=1&articleid=" + ARTICLEID;
            $.post("/article", param, function (data) {
                if (data == "perm-denied") {
                    bootbox.alert({title: "错误提示", message: "权限不足，不能保存草稿"});
                } else if (data == "post=fail") {
                    bootbox.alert({title: "错误提示", message: "保存草稿失败，请联系管理员"});
                } else if (data.match(/^\d+$/)) {
                    bootbox.alert({title: "信息提示", message: "保存草稿成功"});
                    ARTICLEID = parseInt(data)
                    //    保存草稿后，不跳转页面，重新为全局变量赋值
                } else {
                    bootbox.alert({title: "错误提示", message: "保存草稿失败，你可能没有权限"});
                }
            })
        }
    </script>
{% endblock %}

    </div>